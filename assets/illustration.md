## 本项目说明
---
### 1.概述
本项目使用PyQt5开发软件界面，这是一个常用的上位机开发框架。除此之外，视频采集的功能使用OpenCV实现，模型加载及推理借助YOLO官方的PyPi库实现，3D点云借助matplotlib库实现
### 2.软件架构

本节对系统的整体架构、模块划分、数据流与运行时模型做详细说明，方便开发、调试与扩展。

2.1 总体分层
- 表示层（UI）：基于 PyQt5 的窗口系统，负责用户交互、参数设置与可视化展示（二维图像、三维点云、按键控制等）。界面逻辑尽量与业务逻辑解耦，UI 只负责事件分发与数据显示。
- 业务层（控制/编排）：由 `mainwindow.py`、`videowidget.py`、`reason.py` 等模块构成，负责视频流管理、模块间协调、用户指令的下发（例如加载模型、开始/暂停推理、数据保存控制）。
- 推理层（模型推理）：负责加载 YOLO 模型并执行推理。该层采用官方 PyPI 的 YOLO 包进行推理调用，暴露统一的推理接口给业务层，支持模型热加载（Load Model 按钮）。
- 数据处理层：包含预处理（图像缩放、归一化）、后处理（NMS、坐标变换）、与三维点云生成逻辑（将二维检测结果映射为 3D 点）以及数据持久化（保存视频、保存三维坐标 txt）。

2.2 模块划分（文件/类到功能的映射）
- `ui_mainwindow.py` / `mainwindow.ui`：界面描述与控件绑定，所有 UI 元素的初始布局与信号槽在此定义。
- `mainwindow.py`：主控制器，管理界面事件、启动/停止视频读取与推理线程、调度数据保存与 3D 窗口的显示状态。
- `videowidget.py`：视频捕获、帧队列与显示逻辑（封装 OpenCV 读取和 PyQt 显示），为解耦可提供可替换的输入源（摄像头/视频文件）。
- `reason.py`：推理交互与策略（例如，控制何时开始/结束推理、推理结果的阈值配置），以及调用推理层 API。
- `synthesis.py`：将推理结果合成为三维点云数据并提供交互接口（旋转、缩放、投影配置），供 `mainwindow.py` 或 3D 控件调用。
- `main.py`：程序入口，负责解析命令行参数（如调试模式或指定模型路径），启动 Qt 应用。

2.3 数据流（从输入到显示/保存）
1. 输入层：摄像头或视频文件由 `videowidget.py` 读取，帧被放入线程安全的帧队列。
2. 预处理：业务层从队列取帧并按配置（FPS、裁剪、缩放）做预处理。
3. 推理：预处理后帧调用推理层接口进行目标检测，返回边界框、置信度、类别等信息。
4. 后处理与融合：对推理结果做 NMS、坐标变换，并将二维检测信息转换为三维点（synthesis 中的算法），结果被送回 UI 进行绘制和保存。
5. 持久化：根据用户指令在后台保存视频（mp4）或将三维坐标写入 txt 文件，写盘操作应异步化以不阻塞主线程。

2.4 线程与进程模型
- 主线程：运行 Qt 事件循环，负责 UI 更新与用户交互。所有直接与 Qt 控件交互的代码必须在主线程执行。
- 视频读取线程：单独线程负责从摄像头/文件读取帧并推入队列，保证 I/O 与解码不会阻塞 UI。
- 推理线程池：为减少推理阻塞，可使用固定数量的工作线程或线程池（1~2 个线程通常合适，视 GPU/CPU 资源而定），每个线程从帧队列取帧做推理并把结果放入结果队列。
- 保存/写盘线程：异步写入视频文件或 txt 数据，使用独立线程或线程池避免阻塞推理或 UI。
- 进程隔离（可选）：在对性能或稳定性要求高的场景下，可将推理放到独立进程（使用 multiprocessing 或者通过 socket/HTTP RPC 与外部推理服务通信），这样可以避免 Python GIL 对 CPU-bound 操作的影响并在进程崩溃时保护主 UI 进程。

2.5 依赖关系与第三方库
- PyQt5：UI 与事件循环。
- OpenCV（cv2）：视频读取、图像处理与显示预处理功能。
- YOLO 官方 PyPI 包：模型加载与推理。
- matplotlib（或 mpl_toolkits）：三维点云的可视化（当前实现基于 matplotlib）。
- 其它：numpy（数值计算）、scipy（可选的几何/变换函数）、pyinstaller（打包阶段）。

2.6 可扩展点与接口设计
- 推理抽象层：为方便替换推理实现（例如切换到 ONNXRuntime、TensorRT 或 C++ 后端），推理功能应通过统一接口暴露（load_model(path)、infer(frame) -> results）。
- 输入源抽象：摄像头、文件或网络流应实现统一的 DataSource 接口，便于增加 RTSP/HTTP 流或 SDK 驱动。
- 配置中心：将常用参数（模型路径、置信度阈值、FPS、保存路径）集中到配置文件（例如 `config.yaml` 或 `settings.json`）或 Qt 的设置中，便于持久化与远程下发。

2.7 部署与性能考虑
- 硬件：若在带 GPU 的环境运行，优先使用 GPU 加速的推理实现并控制批大小（通常 batch=1 且以低延迟为目标）。在 CPU-only 环境，应降低线程数并优化预处理（例如通过 numba 或 C++ 扩展）。
- 内存与队列：限制帧队列长度以避免 OOM（建议使用有界队列并在队列满时丢帧或降采样）。
- 延迟与吞吐：测量并记录关键路径的耗时（读取、预处理、推理、后处理、绘制），根据瓶颈调整线程分配或迁移到进程/原生代码实现。

2.8 错误处理、日志与测试
- 异常隔离：推理/读取出错应捕获并将错误信息通过信号发送给 UI（避免主线程崩溃），并根据错误类型选择重试或回退策略。
- 日志：使用 logging 模块记录关键事件（模型加载、推理异常、保存失败），支持文件与控制台两种输出等级（INFO/DEBUG/ERROR）。
- 单元/集成测试：对推理接口、数据转换（2D->3D）和文件保存模块编写测试用例，保证核心逻辑在改动后仍然正确。

2.9 安全与权限
- 文件权限：写入路径应做权限检测，避免因权限问题导致崩溃。
- 模型来源验证：防止加载未经过验证的模型文件时带来的异常或安全隐患，建议在加载时做基本的文件完整性检查（大小/后缀/简单签名）。

2.10 小结
本架构以界面和业务逻辑解耦为目标，采用多线程/可选进程隔离的运行时模型，便于替换推理后端与扩展输入源。后续若要提升性能，可把推理与关键数据处理迁移到 C++/CUDA 层并通过 pybind/扩展绑定回 Python UI 层。

### 3.模块说明
- 本软件的主界面，由三个主要窗口构成，从左到右依次为二维正面图像窗口，二维侧面图像窗口，三维点云交互窗口。
- 两个二维图像窗口上的索引选择条可以选择二维图像的输入相机（0-3）或者使用视频文件（file）输入。
- 在两个图像选择条的下方为视频选择文件键，可以选择.avi .mp4 .mov格式的视频文件用作索引选择条选为“file”时的输入
- 在两个视频文件选择键的下方为FPS（帧率）设置，可以调整图像加载时的帧率。请注意，这里的加载帧率为输入帧率，实际显示时受限于图像推理与处理，帧率会低于设定值
- 在两个显示窗口下方会有两个独立按键- “Start”与“Pause”按键，这两个按键控制图像的显示与否，是最底层的控制
- 两个按键下方，会有“isMark”选择项，该选择项用于相机前期的位置调整，当勾选它时，会在图像上绘制参考线
- 在“Reason”区域中，有三个按钮：“Load Model”按钮用于加载yolo模型，点击后可以选择.pt格式的模型权重文件；“Start”与“End”按钮控制是否对显示的视频进行推理，当无视频流输入时这两个按钮无法交互
- 最后，可以在最右侧用于3D点云显示交互的窗口下看见一个红色按钮，该按钮单独控制3D窗口，当无视频展示输出时该按钮无法交互，当有视频流时，点击按钮会切换3D窗口的状态，按钮为红色时3D点云不输出，为绿色时显示点云
#### 接下来的模块仅在采集版软件才有，对于展示版软件无下列模块
- 在“Save Video”区域中，有三个按钮-“Start” “Pause” “End”，用来控制视频文件的保存与否，只能保存为.mp4格式
- 在“Data Save”区域中，有两个按钮-“Start” “End”，用于控制数据的保存与否，会将三个球的三维运动坐标数据保存为三个.txt文件，方便后续处理
### 4.可改进之处
- [ ] 由于本项目使用Python开发，故打包可执行文件时选用了Pyinstaller， 但是其产生的可执行文件体积很大，且运行速率低，可以采用Pybind的方法将ui和推理相关功能用C++实现 
- [ ] 若使用了C++和Pybind的组合，推荐切换为Nuitka进行打包
- [ ] ui的style可以进一步美化
